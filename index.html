<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-One Chat | Official</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #fafafa; margin: 0; padding-bottom: 50px; }
        .header { background: white; border-bottom: 1px solid #dbdbdb; padding: 10px 0; text-align: center; position: sticky; top: 0; z-index: 1000; }
        .main-container { max-width: 500px; margin: 20px auto; padding: 10px; }
        
        /* Cards & UI Elements */
        .card { background: white; border: 1px solid #dbdbdb; border-radius: 8px; padding: 20px; margin-bottom: 20px; text-align: center; }
        input[type="text"], input[type="file"] { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #dbdbdb; border-radius: 4px; box-sizing: border-box; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-primary { background-color: #0095f6; color: white; }
        .btn-primary:hover { background-color: #1877f2; }
        .btn-logout { margin-top: 10px; background: none; color: #ed4956; font-size: 12px; }

        /* Post Styling */
        .post-card { background: white; border: 1px solid #dbdbdb; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .post-header { padding: 10px; font-weight: bold; display: flex; align-items: center; border-bottom: 1px solid #efefef; }
        .user-pic { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; border: 1px solid #dbdbdb; }
        .post-image { width: 100%; display: block; object-fit: cover; max-height: 500px; }
        .post-content { padding: 12px; }
        .post-caption { font-size: 14px; margin-bottom: 5px; }
        .post-time { color: #8e8e8e; font-size: 10px; }
        .like-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; outline: none; }
        
        #loader { text-align: center; margin-top: 100px; font-size: 18px; color: #8e8e8e; }
    </style>
</head>
<body>

    <div class="header">
        <h2 style="margin:0; color: #262626;">A-One Chat</h2>
    </div>

    <div id="loader">Syncing...</div>

    <div class="main-container" id="main-content" style="display:none;">
        <div id="login-section" class="card" style="display:none;">
            <h3>Welcome</h3>
            <p>Login to explore A-One Chat</p>
            <button class="btn-primary" onclick="googleLogin()">Login with Google</button>
        </div>

        <div id="upload-section" class="card" style="display:none;">
            <p id="welcome-msg" style="font-weight: bold;"></p>
            <input type="file" id="image-input" accept="image/*">
            <input type="text" id="caption-input" placeholder="Write a caption...">
            <button id="post-btn" class="btn-primary" onclick="handlePost()">Post Now</button>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>

        <div id="feed-section"></div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAthFMO8zGT5BtiOkh4zkc71jL06LR_F9c",
            authDomain: "a-one-chat-19ad6.firebaseapp.com",
            databaseURL: "https://a-one-chat-19ad6-default-rtdb.firebaseio.com",
            projectId: "a-one-chat-19ad6",
            storageBucket: "a-one-chat-19ad6.firebasestorage.app",
            messagingSenderId: "691783470864",
            appId: "1:691783470864:web:0b119fcddf984af66e5f95",
            measurementId: "G-ELVERPXDW3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // 1. Auth Observer (Check if user is logged in)
        onAuthStateChanged(auth, (user) => {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';

            if (user) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('upload-section').style.display = 'block';
                document.getElementById('welcome-msg').innerText = "Hi, " + user.displayName;
                loadPosts();
            } else {
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('feed-section').innerHTML = "";
            }
        });

        // 2. Google Login
        window.googleLogin = async () => {
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert("Login Error: " + error.message);
            }
        };

        // 3. Logout
        window.logout = () => signOut(auth);

        // 4. Like/Unlike Feature
        window.toggleLike = async (postId, likesArray) => {
            const user = auth.currentUser;
            if (!user) return alert("Please login to like!");

            const postRef = doc(db, "posts", postId);
            const isLiked = likesArray && likesArray.includes(user.uid);

            try {
                await updateDoc(postRef, {
                    likes: isLiked ? arrayRemove(user.uid) : arrayUnion(user.uid)
                });
            } catch (err) {
                console.error("Like Error:", err);
            }
        };

        // 5. Handle Upload to Cloudinary and Save to Firestore
        window.handlePost = async () => {
            const fileInput = document.getElementById('image-input');
            const captionInput = document.getElementById('caption-input');
            const postBtn = document.getElementById('post-btn');

            if (!fileInput.files[0]) return alert("Select an image first!");

            postBtn.innerText = "Uploading...";
            postBtn.disabled = true;

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("upload_preset", "mloo8sj4");

            try {
                const res = await fetch("https://api.cloudinary.com/v1_1/dpr1oyqat/image/upload", {
                    method: "POST",
                    body: formData
                });
                const data = await res.json();

                await addDoc(collection(db, "posts"), {
                    imageUrl: data.secure_url,
                    caption: captionInput.value,
                    username: auth.currentUser.displayName,
                    userPhoto: auth.currentUser.photoURL,
                    uid: auth.currentUser.uid,
                    likes: [],
                    timestamp: serverTimestamp()
                });

                fileInput.value = "";
                captionInput.value = "";
                alert("Posted!");
            } catch (err) {
                alert("Upload failed. Check Cloudinary settings.");
            } finally {
                postBtn.innerText = "Post Now";
                postBtn.disabled = false;
            }
        };

        // 6. Real-time Feed Listener
        function loadPosts() {
            const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const feed = document.getElementById('feed-section');
                feed.innerHTML = "";
                snapshot.forEach((postDoc) => {
                    const post = postDoc.data();
                    const postId = postDoc.id;
                    const likesCount = post.likes ? post.likes.length : 0;
                    const isLiked = post.likes && post.likes.includes(auth.currentUser?.uid);
                    const time = post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleString() : "Just now";
                    
                    feed.innerHTML += `
                        <div class="post-card">
                            <div class="post-header">
                                <img class="user-pic" src="${post.userPhoto || 'https://via.placeholder.com/32'}">
                                <span>${post.username}</span>
                            </div>
                            <img class="post-image" src="${post.imageUrl}">
                            <div class="post-content">
                                <button class="like-btn" onclick="toggleLike('${postId}', ${JSON.stringify(post.likes || [])})">
                                    ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}
                                </button>
                                <div style="font-weight:bold; font-size:14px; margin: 2px 0;">${likesCount} likes</div>
                                <div class="post-caption"><b>${post.username}</b> ${post.caption || ""}</div>
                                <div class="post-time">${time}</div>
                            </div>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>
